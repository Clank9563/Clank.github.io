<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœå°‹çµæœ - clankçš„å€‹äººåšå®¢</title>
    <link rel="stylesheet" href="src/styles/main.css">
</head>

<body>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="index.html" class="navbar-brand">
                ğŸ’¬ clankçš„å€‹äººåšå®¢
            </a>
            <div class="navbar-actions">
                <div id="userInfo"></div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="main-content">
        <div class="container">
            <a href="index.html" class="back-link">
                â† è¿”å›é¦–é 
            </a>

            <!-- æœå°‹æ¡† -->
            <div class="search-container" style="max-width: 100%; margin-top: 2rem;">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹è¨è«–æ¨™é¡Œæˆ–å…§å®¹..." autofocus>
                <button id="clearSearch" class="search-clear" style="display: none;">âœ•</button>
            </div>

            <!-- æœå°‹çµæœæ¨™é¡Œ -->
            <div class="discussions-header" style="margin-top: 2rem;">
                <h1 id="resultsTitle">æœå°‹çµæœ</h1>
            </div>

            <!-- æœå°‹çµæœåˆ—è¡¨ -->
            <div class="discussions-grid" id="searchResults">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ”</div>
                    <h2>è¼¸å…¥é—œéµå­—é–‹å§‹æœå°‹</h2>
                    <p>æœå°‹è¨è«–æ¨™é¡Œå’Œå…§å®¹</p>
                </div>
            </div>
        </div>
    </main>

    <!-- é…ç½® -->
    <script>
        window.GITHUB_CONFIG = {
            owner: 'Clank9563',
            repo: 'Clank.github.io'
        };
    </script>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <script type="module">
        import GitHubClient from './src/api/github-client.js';
        import * as auth from './src/api/auth.js';
        import * as ui from './src/js/ui.js';
        import { handleError, getQueryParam } from './src/js/utils.js';

        const client = new GitHubClient(
            window.GITHUB_CONFIG.owner,
            window.GITHUB_CONFIG.repo
        );

        let currentUser = null;
        let searchTimeout = null;

        // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
        async function loadUser() {
            try {
                currentUser = await client.getCurrentUser();
                ui.renderUserInfo(currentUser, document.getElementById('userInfo'));

                const loginBtn = document.getElementById('loginBtn');
                const logoutBtn = document.getElementById('logoutBtn');

                if (loginBtn) {
                    loginBtn.addEventListener('click', auth.login);
                }

                if (logoutBtn) {
                    logoutBtn.addEventListener('click', auth.logout);
                }
            } catch (error) {
                console.error('Failed to load user:', error);
                ui.renderUserInfo(null, document.getElementById('userInfo'));

                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', auth.login);
                }
            }
        }

        // åŸ·è¡Œæœå°‹
        async function performSearch(query) {
            const resultsContainer = document.getElementById('searchResults');
            const resultsTitle = document.getElementById('resultsTitle');

            if (!query || query.trim() === '') {
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <h2>è¼¸å…¥é—œéµå­—é–‹å§‹æœå°‹</h2>
                        <p>æœå°‹è¨è«–æ¨™é¡Œå’Œå…§å®¹</p>
                    </div>
                `;
                resultsTitle.textContent = 'æœå°‹çµæœ';
                return;
            }

            try {
                ui.renderLoading(resultsContainer);
                resultsTitle.textContent = `æœå°‹ã€Œ${query}ã€...`;

                const result = await client.searchDiscussions(query);

                resultsTitle.textContent = `æ‰¾åˆ° ${result.totalCount} å€‹çµæœ`;

                if (result.nodes.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ˜•</div>
                            <h2>æ‰¾ä¸åˆ°ç›¸é—œè¨è«–</h2>
                            <p>è©¦è©¦å…¶ä»–é—œéµå­—</p>
                        </div>
                    `;
                } else {
                    ui.renderDiscussions(result.nodes, resultsContainer);
                }
            } catch (error) {
                ui.renderError(handleError(error, 'searchDiscussions'), resultsContainer);
                resultsTitle.textContent = 'æœå°‹å¤±æ•—';
            }
        }

        // æœå°‹è¼¸å…¥äº‹ä»¶
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearSearch');

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value;

            // é¡¯ç¤º/éš±è—æ¸…é™¤æŒ‰éˆ•
            clearBtn.style.display = query ? 'block' : 'none';

            // é˜²æŠ–ï¼šå»¶é²æœå°‹
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 500);
        });

        // æ¸…é™¤æœå°‹
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            clearBtn.style.display = 'none';
            performSearch('');
        });

        // å¾ URL ç²å–æœå°‹é—œéµå­—
        const urlQuery = getQueryParam('q');
        if (urlQuery) {
            searchInput.value = decodeURIComponent(urlQuery);
            performSearch(urlQuery);
        }

        // åˆå§‹åŒ–
        loadUser();
    </script>
</body>

</html>