<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Discussions è«–å£‡</title>
    <meta name="description" content="åŸºæ–¼ GitHub Discussions çš„ç¾ä»£åŒ–è«–å£‡ç³»çµ±">
    <link rel="stylesheet" href="src/styles/main.css">
</head>

<body>
    <script>
        window.onerror = function (msg, url, line, col, error) {
            alert("âŒ éŒ¯èª¤åµæ¸¬:\n" + msg + "\n\næª”æ¡ˆ: " + url + "\nè¡Œæ•¸: " + line);
            return false;
        };
        window.addEventListener('unhandledrejection', function (event) {
            alert("âŒ éåŒæ­¥éŒ¯èª¤:\n" + event.reason);
        });
    </script>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="index.html" class="navbar-brand">
                ğŸ’¬ clankçš„å€‹äººåšå®¢
            </a>
            <div class="navbar-actions">
                <div id="userInfo"></div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="main-content">
        <div class="container">
            <!-- é é¦– -->
            <div class="discussions-header">
                <h1>ğŸ“‹ è«–å£‡åˆ†é¡</h1>
                <button class="btn btn-primary" id="newDiscussionBtn" style="display: none;">
                    âœï¸ ç™¼èµ·è¨è«–
                </button>
            </div>

            <!-- æœå°‹æ¡† -->
            <div class="search-container">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹è¨è«–...">
            </div>

            <!-- åˆ†é¡ç‰ˆå¡Šåˆ—è¡¨ -->
            <div class="categories-grid" id="categoriesList">
                <!-- åˆ†é¡å¡ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            </div>
        </div>
    </main>

    <!-- é…ç½® -->
    <script>
        window.GITHUB_CONFIG = {
            owner: 'Clank9563',
            repo: 'Clank.github.io'
        };
    </script>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <script type="module">
        import GitHubClient from './src/api/github-client.js';
        import * as auth from './src/api/auth.js';
        import { handleError } from './src/js/utils.js';

        // åˆ†é¡åç¨±å°æ‡‰è¡¨ï¼ˆè‹±æ–‡ -> ä¸­æ–‡ï¼‰
        const categoryNameMap = {
            'Announcements': 'å…¬å‘Š',
            'General': 'äº¤æµè¨è«–å€',
            'Ideas': 'å»ºè­°èˆ‡æƒ³æ³•',
            'Polls': 'æŠ•ç¥¨',
            'Q&A': 'å•ç­”å€',
            'Show and tell': 'æ•™å­¸èˆ‡ç¯„ä¾‹å€'
        };

        // Emoji ä»£ç¢¼å°æ‡‰è¡¨
        const emojiMap = {
            ':mega:': 'ğŸ“¢',
            ':speech_balloon:': 'ğŸ’¬',
            ':bulb:': 'ğŸ’¡',
            ':ballot_box:': 'ğŸ—³ï¸',
            ':question:': 'â“',
            ':raised_hands:': 'ğŸ“',
            ':pray:': 'ğŸ™'
        };

        // ç¿»è­¯åˆ†é¡åç¨±
        function translateCategoryName(name) {
            return categoryNameMap[name] || name;
        }

        // è½‰æ› emoji ä»£ç¢¼ç‚ºå¯¦éš› emoji
        function convertEmoji(emojiCode) {
            return emojiMap[emojiCode] || emojiCode;
        }

        // åˆå§‹åŒ–
        const client = new GitHubClient(
            window.GITHUB_CONFIG.owner,
            window.GITHUB_CONFIG.repo
        );

        let currentUser = null;
        let allDiscussions = [];

        // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
        async function loadUser() {
            try {
                currentUser = await client.getCurrentUser();
                renderUserInfo(currentUser);

                const loginBtn = document.getElementById('loginBtn');
                const logoutBtn = document.getElementById('logoutBtn');
                const newDiscussionBtn = document.getElementById('newDiscussionBtn');

                if (loginBtn) {
                    loginBtn.addEventListener('click', auth.login);
                }

                if (logoutBtn) {
                    logoutBtn.addEventListener('click', auth.logout);
                }

                if (currentUser && newDiscussionBtn) {
                    newDiscussionBtn.style.display = 'inline-flex';
                    newDiscussionBtn.addEventListener('click', () => {
                        window.location.href = 'new-discussion.html';
                    });
                }
            } catch (error) {
                console.error('Failed to load user:', error);
                renderUserInfo(null);

                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', auth.login);
                }
            }
        }

        // æ¸²æŸ“ä½¿ç”¨è€…è³‡è¨Š
        function renderUserInfo(user) {
            const container = document.getElementById('userInfo');
            if (!user) {
                container.innerHTML = `
                    <button class="btn btn-primary" id="loginBtn">
                        ğŸ” ä½¿ç”¨ GitHub ç™»å…¥
                    </button>
                `;
                return;
            }

            container.innerHTML = `
                <div class="user-info">
                    <img src="${user.avatarUrl}" alt="${user.login}" class="user-avatar">
                    <span class="user-name">${user.login}</span>
                    <button class="btn btn-ghost btn-sm" id="logoutBtn">ç™»å‡º</button>
                </div>
            `;
        }

        // è¼‰å…¥æ‰€æœ‰è¨è«–ï¼ˆç”¨æ–¼çµ±è¨ˆï¼‰
        async function loadAllDiscussions() {
            try {
                const result = await client.getDiscussions(100);
                allDiscussions = result.nodes;
            } catch (error) {
                console.error('Failed to load discussions:', error);
            }
        }

        // è¼‰å…¥ä¸¦é¡¯ç¤ºåˆ†é¡ç‰ˆå¡Š
        async function loadCategories() {
            const container = document.getElementById('categoriesList');

            try {
                container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                const categories = await client.getCategories();
                await loadAllDiscussions();

                // è¨ˆç®—æ¯å€‹åˆ†é¡çš„è¨è«–æ•¸é‡
                const categoriesWithCounts = categories.map(cat => {
                    const count = allDiscussions.filter(d => d.category.name === cat.name).length;
                    const latestDiscussion = allDiscussions
                        .filter(d => d.category.name === cat.name)
                        .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))[0];

                    return {
                        ...cat,
                        discussionCount: count,
                        latestDiscussion
                    };
                });

                renderCategories(categoriesWithCounts);
            } catch (error) {
                container.innerHTML = `
                    <div class="error-message">
                        <strong>âŒ éŒ¯èª¤</strong>
                        <p>${handleError(error, 'loadCategories')}</p>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“åˆ†é¡ç‰ˆå¡Šåˆ—è¡¨
        function renderCategories(categories) {
            const container = document.getElementById('categoriesList');

            if (!categories || categories.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <h2>ç›®å‰æ²’æœ‰åˆ†é¡</h2>
                    </div>
                `;
                return;
            }

            const html = categories.map(cat => {
                const translatedName = translateCategoryName(cat.name);
                const emoji = convertEmoji(cat.emoji);
                return `
                <a href="category.html?id=${encodeURIComponent(cat.id)}&name=${encodeURIComponent(cat.name)}" class="category-card">
                    <div class="category-header">
                        <div class="category-icon">${emoji}</div>
                        <div class="category-info">
                            <h2 class="category-title">${translatedName}</h2>
                            ${cat.description ? `<p class="category-description">${cat.description}</p>` : ''}
                        </div>
                    </div>
                    <div class="category-stats">
                        <div class="stat-item">
                            <span class="stat-number">${cat.discussionCount}</span>
                            <span class="stat-label">ç¯‡æ–‡ç« </span>
                        </div>
                        ${cat.latestDiscussion ? `
                            <div class="category-latest">
                                <span class="latest-label">æœ€æ–°ï¼š</span>
                                <span class="latest-title">${cat.latestDiscussion.title}</span>
                            </div>
                        ` : ''}
                    </div>
                </a>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // æœå°‹åŠŸèƒ½
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) {
                        window.location.href = `search.html?q=${encodeURIComponent(query)}`;
                    }
                }
            });
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        async function init() {
            await loadUser();
            await loadCategories();
        }

        init();
    </script>
</body>

</html>