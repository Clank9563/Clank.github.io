<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™¼èµ·æ–°è¨è«– - GitHub Discussions è«–å£‡</title>
    <link rel="stylesheet" href="src/styles/main.css">
    <style>
        /* æ–°è¨è«–é é¢å°ˆç”¨æ¨£å¼ */
        .new-discussion-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: all var(--transition-fast);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            min-height: 300px;
            resize: vertical;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .form-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
        }

        .preview-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            min-height: 200px;
        }

        .tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all var(--transition-fast);
        }

        .tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .help-text {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: var(--spacing-xs);
        }

        .required {
            color: hsl(0, 70%, 60%);
        }
    </style>
</head>

<body>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="index.html" class="navbar-brand">
                ğŸ’¬ clankçš„å€‹äººåšå®¢
            </a>
            <div class="navbar-actions">
                <div id="userInfo"></div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="main-content">
        <div class="container new-discussion-container">
            <a href="index.html" class="back-link"
                style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); text-decoration: none; margin-bottom: 1.5rem;">
                â† è¿”å›è¨è«–åˆ—è¡¨
            </a>

            <h1 style="margin-bottom: 2rem;">âœï¸ ç™¼èµ·æ–°è¨è«–</h1>

            <form id="newDiscussionForm">
                <!-- åˆ†é¡é¸æ“‡ -->
                <div class="form-group">
                    <label class="form-label" for="category">
                        è¨è«–åˆ†é¡ <span class="required">*</span>
                    </label>
                    <select id="category" class="form-select" required>
                        <option value="">è«‹é¸æ“‡åˆ†é¡...</option>
                    </select>
                    <div class="help-text">é¸æ“‡æœ€é©åˆæ‚¨è¨è«–ä¸»é¡Œçš„åˆ†é¡</div>
                </div>

                <!-- æ¨™ç±¤é¸æ“‡ -->
                <div class="form-group">
                    <label class="form-label">æ¨™ç±¤</label>
                    <div id="labelsContainer" class="labels-container">
                        <div class="loading-small">è¼‰å…¥æ¨™ç±¤ä¸­...</div>
                    </div>
                    <div class="help-text">é¸æ“‡é©åˆçš„æ¨™ç±¤ï¼ˆå¯å¤šé¸ï¼‰</div>
                    <style>
                        .labels-container {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 0.5rem;
                            padding: 0.5rem;
                            border: 1px solid var(--border-color);
                            border-radius: var(--radius-md);
                            background: var(--bg-tertiary);
                            min-height: 42px;
                        }

                        .label-checkbox {
                            display: none;
                        }

                        .label-option {
                            display: inline-flex;
                            align-items: center;
                            padding: 4px 12px;
                            border-radius: 2em;
                            font-size: 0.875rem;
                            cursor: pointer;
                            border: 1px solid transparent;
                            transition: all 0.2s;
                            user-select: none;
                            background: var(--bg-secondary);
                            color: var(--text-secondary);
                            border-color: var(--border-color);
                        }

                        .label-checkbox:checked+.label-option {
                            color: #fff;
                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                            border-color: transparent;
                        }

                        .loading-small {
                            font-size: 0.875rem;
                            color: var(--text-secondary);
                            padding: 0.25rem;
                        }
                    </style>
                </div>

                <!-- æ¨™é¡Œ -->
                <div class="form-group">
                    <label class="form-label" for="title">
                        è¨è«–æ¨™é¡Œ <span class="required">*</span>
                    </label>
                    <input type="text" id="title" class="form-input" placeholder="è¼¸å…¥ä¸€å€‹æ¸…æ™°ã€æè¿°æ€§çš„æ¨™é¡Œ..." required
                        maxlength="200">
                    <div class="help-text">æ¨™é¡Œæ‡‰è©²ç°¡æ½”æ˜ç­ï¼Œè®“å…¶ä»–äººä¸€çœ¼å°±èƒ½äº†è§£è¨è«–ä¸»é¡Œ</div>
                </div>

                <!-- å…§å®¹ç·¨è¼¯å™¨ -->
                <div class="form-group">
                    <label class="form-label">
                        è¨è«–å…§å®¹ <span class="required">*</span>
                    </label>

                    <!-- æ¨™ç±¤åˆ‡æ› -->
                    <div class="tabs">
                        <button type="button" class="tab active" data-tab="write">
                            âœï¸ ç·¨è¼¯
                        </button>
                        <button type="button" class="tab" data-tab="preview">
                            ğŸ‘ï¸ é è¦½
                        </button>
                    </div>

                    <!-- ç·¨è¼¯å€ -->
                    <div id="writeTab">
                        <textarea id="body" class="form-textarea"
                            placeholder="ä½¿ç”¨ Markdown æ ¼å¼æ’°å¯«æ‚¨çš„è¨è«–å…§å®¹...&#10;&#10;æ”¯æ´ï¼š&#10;- **ç²—é«”** å’Œ *æ–œé«”*&#10;- [é€£çµ](url)&#10;- `ç¨‹å¼ç¢¼`&#10;- æ¸…å–®ã€å¼•ç”¨ç­‰"
                            required></textarea>
                    </div>

                    <!-- é è¦½å€ -->
                    <div id="previewTab" style="display: none;">
                        <div class="preview-container markdown-body" id="preview">
                            <p style="color: var(--text-secondary);">é è¦½å°‡é¡¯ç¤ºåœ¨é€™è£¡...</p>
                        </div>
                    </div>

                    <div class="help-text">æ”¯æ´ Markdown æ ¼å¼ï¼Œå¯ä½¿ç”¨é è¦½åŠŸèƒ½æŸ¥çœ‹æœ€çµ‚æ•ˆæœ</div>
                </div>

                <!-- æäº¤æŒ‰éˆ• -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        ğŸš€ ç™¼è¡¨è¨è«–
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- é…ç½® -->
    <script>
        window.GITHUB_CONFIG = {
            owner: 'Clank9563',
            repo: 'Clank.github.io'
        };
    </script>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <script type="module">
        import GitHubClient from './src/api/github-client.js';
        import * as auth from './src/api/auth.js';
        import * as ui from './src/js/ui.js';
        import { handleError, translateLabel } from './src/js/utils.js';
        import { marked } from 'https://cdn.jsdelivr.net/npm/marked@11.1.0/+esm';

        // åˆ†é¡åç¨±å°æ‡‰è¡¨ï¼ˆè‹±æ–‡ -> ä¸­æ–‡ï¼‰
        const categoryNameMap = {
            'Announcements': 'å…¬å‘Š',
            'General': 'äº¤æµè¨è«–å€',
            'Ideas': 'å»ºè­°èˆ‡æƒ³æ³•',
            'Polls': 'æŠ•ç¥¨',
            'Q&A': 'å•ç­”å€',
            'Show and tell': 'æ•™å­¸èˆ‡ç¯„ä¾‹å€'
        };

        // Emoji ä»£ç¢¼å°æ‡‰è¡¨
        const emojiMap = {
            ':mega:': 'ğŸ“¢',
            ':speech_balloon:': 'ğŸ’¬',
            ':bulb:': 'ğŸ’¡',
            ':ballot_box:': 'ğŸ—³ï¸',
            ':question:': 'â“',
            ':raised_hands:': 'ğŸ“',
            ':pray:': 'ğŸ™'
        };

        // ç¿»è­¯åˆ†é¡åç¨±
        function translateCategoryName(name) {
            return categoryNameMap[name] || name;
        }

        // è½‰æ› emoji ä»£ç¢¼ç‚ºå¯¦éš› emoji
        function convertEmoji(emojiCode) {
            return emojiMap[emojiCode] || emojiCode;
        }

        const client = new GitHubClient(
            window.GITHUB_CONFIG.owner,
            window.GITHUB_CONFIG.repo
        );

        let currentUser = null;

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        async function checkAuth() {
            currentUser = await client.getCurrentUser();

            if (!currentUser) {
                alert('æ‚¨éœ€è¦å…ˆç™»å…¥æ‰èƒ½ç™¼èµ·è¨è«–');
                window.location.href = 'index.html';
                return false;
            }

            ui.renderUserInfo(currentUser, document.getElementById('userInfo'));

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', auth.logout);
            }

            return true;
        }

        // è¼‰å…¥åˆ†é¡
        async function loadCategories() {
            try {
                const categories = await client.getCategories();
                const select = document.getElementById('category');

                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    const emoji = convertEmoji(cat.emoji);
                    const translatedName = translateCategoryName(cat.name);
                    option.textContent = `${emoji} ${translatedName}`;
                    if (cat.description) {
                        option.title = cat.description;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load categories:', error);
                alert('è¼‰å…¥åˆ†é¡å¤±æ•—ï¼š' + handleError(error));
            }
        }

        // æ¨™ç±¤åˆ‡æ›
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // åˆ‡æ›å…§å®¹
                if (tabName === 'write') {
                    document.getElementById('writeTab').style.display = 'block';
                    document.getElementById('previewTab').style.display = 'none';
                } else {
                    document.getElementById('writeTab').style.display = 'none';
                    document.getElementById('previewTab').style.display = 'block';

                    // æ›´æ–°é è¦½
                    const body = document.getElementById('body').value;
                    const preview = document.getElementById('preview');
                    if (body.trim()) {
                        preview.innerHTML = marked.parse(body);
                    } else {
                        preview.innerHTML = '<p style="color: var(--text-secondary);">é è¦½å°‡é¡¯ç¤ºåœ¨é€™è£¡...</p>';
                    }
                }
            });
        });

        // Helper function to escape HTML for safe rendering
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // è¼‰å…¥æ¨™ç±¤
        async function loadLabels() {
            const container = document.getElementById('labelsContainer');
            try {
                const labels = await client.getLabels();

                if (labels.length === 0) {
                    container.innerHTML = '<div class="loading-small">æ²’æœ‰å¯ç”¨æ¨™ç±¤</div>';
                    return;
                }

                container.innerHTML = labels.map(label => `
                    <label>
                        <input type="checkbox" name="labels" value="${label.id}" class="label-checkbox">
                        <span class="label-option" style="--active-color: #${label.color}">
                            ${escapeHtml(translateLabel(label.name))}
                        </span>
                    </label>
                `).join('');

                // æ·»åŠ é»æ“Šäº‹ä»¶è™•ç†é¡è‰²
                container.querySelectorAll('.label-checkbox').forEach(checkbox => {
                    const span = checkbox.nextElementSibling;
                    const color = span.style.getPropertyValue('--active-color');

                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            span.style.backgroundColor = color;
                            // åˆ¤æ–·äº®åº¦æ±ºå®šæ–‡å­—é¡è‰²
                            span.style.color = '#fff';
                        } else {
                            span.style.backgroundColor = '';
                            span.style.color = '';
                        }
                    });
                });

            } catch (error) {
                console.error('Failed to load labels:', error);
                container.innerHTML = '<div class="loading-small">è¼‰å…¥æ¨™ç±¤å¤±æ•—</div>';
            }
        }

        // æäº¤è¡¨å–®
        async function handleSubmit(e) {
            e.preventDefault();

            const categoryId = document.getElementById('category').value;
            const title = document.getElementById('title').value.trim();
            const body = document.getElementById('body').value.trim();

            // ç²å–é¸ä¸­çš„æ¨™ç±¤
            const selectedLabels = Array.from(document.querySelectorAll('input[name="labels"]:checked'))
                .map(input => input.value);

            if (!categoryId || !title || !body) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'ç™¼å¸ƒä¸­...';

            try {
                // 1. å»ºç«‹è¨è«–
                const discussion = await client.createDiscussion(categoryId, title, body);

                // 2. å¦‚æœæœ‰é¸æ¨™ç±¤ï¼Œæ·»åŠ æ¨™ç±¤
                if (selectedLabels.length > 0) {
                    submitBtn.textContent = 'æ·»åŠ æ¨™ç±¤ä¸­...';
                    try {
                        await client.addLabels(discussion.id, selectedLabels);
                    } catch (labelError) {
                        console.error('Failed to add labels:', labelError);
                        alert('è¨è«–å·²å»ºç«‹ï¼Œä½†æ¨™ç±¤æ·»åŠ å¤±æ•—ï¼š' + handleError(labelError));
                    }
                }

                // 3. æˆåŠŸè·³è½‰
                alert('è¨è«–ç™¼å¸ƒæˆåŠŸï¼');
                window.location.href = `discussion.html?number=${discussion.number}`;
            } catch (error) {
                console.error('Failed to create discussion:', error);
                alert('ç™¼å¸ƒå¤±æ•—ï¼š' + handleError(error, 'createDiscussion'));
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        document.getElementById('newDiscussionForm').addEventListener('submit', handleSubmit);

        // åˆå§‹åŒ–
        async function init() {
            try {
                console.log('Starting initialization...');
                const hasAuth = await checkAuth();
                console.log('Auth check result:', hasAuth);

                if (hasAuth) {
                    console.log('Loading categories...');
                    await loadCategories();
                    console.log('Categories loaded.');

                    console.log('Loading labels...');
                    await loadLabels();
                    console.log('Labels loaded.');
                }
            } catch (error) {
                console.error('Initialization failed:', error);
                alert('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°æ—¥èªŒã€‚');
            }
        }

        // ç¢ºä¿ DOM è¼‰å…¥å¾ŒåŸ·è¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>