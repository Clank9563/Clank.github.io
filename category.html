<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†é¡è¨è«– - GitHub Discussions è«–å£‡</title>
    <link rel="stylesheet" href="src/styles/main.css">
</head>

<body>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="index.html" class="navbar-brand">
                ğŸ’¬ clankçš„å€‹äººåšå®¢
            </a>
            <div class="navbar-actions">
                <div id="userInfo"></div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="main-content">
        <div class="container">
            <a href="index.html" class="back-link">
                â† è¿”å›è«–å£‡é¦–é 
            </a>

            <!-- åˆ†é¡æ¨™é¡Œ -->
            <div class="discussions-header">
                <h1 id="categoryTitle">ğŸ“‹ è¼‰å…¥ä¸­...</h1>
                <button class="btn btn-primary" id="newDiscussionBtn" style="display: none;">
                    âœï¸ ç™¼èµ·è¨è«–
                </button>
            </div>

            <!-- è¨è«–åˆ—è¡¨ -->
            <div class="discussions-grid" id="discussionsList">
                <!-- è¨è«–å¡ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            </div>

            <!-- è¼‰å…¥æ›´å¤š -->
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-secondary" id="loadMoreBtn" style="display: none;">
                    è¼‰å…¥æ›´å¤š
                </button>
            </div>
        </div>
    </main>

    <!-- é…ç½® -->
    <script>
        window.GITHUB_CONFIG = {
            owner: 'Clank9563',
            repo: 'Clank.github.io'
        };
    </script>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <script type="module">
        import GitHubClient from './src/api/github-client.js';
        import * as auth from './src/api/auth.js';
        import * as ui from './src/js/ui.js';
        import { handleError, getQueryParam } from './src/js/utils.js';

        // åˆ†é¡åç¨±å°æ‡‰è¡¨ï¼ˆè‹±æ–‡ -> ä¸­æ–‡ï¼‰
        const categoryNameMap = {
            'Announcements': 'å…¬å‘Š',
            'General': 'äº¤æµè¨è«–å€',
            'Ideas': 'å»ºè­°èˆ‡æƒ³æ³•',
            'Polls': 'æŠ•ç¥¨',
            'Q&A': 'å•ç­”å€',
            'Show and tell': 'æ•™å­¸èˆ‡ç¯„ä¾‹å€'
        };

        // Emoji ä»£ç¢¼å°æ‡‰è¡¨
        const emojiMap = {
            ':mega:': 'ğŸ“¢',
            ':speech_balloon:': 'ğŸ’¬',
            ':bulb:': 'ğŸ’¡',
            ':ballot_box:': 'ğŸ—³ï¸',
            ':question:': 'â“',
            ':raised_hands:': 'ğŸ“',
            ':pray:': 'ğŸ™'
        };

        // ç¿»è­¯åˆ†é¡åç¨±
        function translateCategoryName(name) {
            return categoryNameMap[name] || name;
        }

        const client = new GitHubClient(
            window.GITHUB_CONFIG.owner,
            window.GITHUB_CONFIG.repo
        );

        let currentUser = null;
        let currentCategoryId = '';
        let currentCategoryName = '';
        let discussions = [];
        let hasNextPage = false;
        let endCursor = null;

        // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
        async function loadUser() {
            try {
                currentUser = await client.getCurrentUser();
                ui.renderUserInfo(currentUser, document.getElementById('userInfo'));

                const loginBtn = document.getElementById('loginBtn');
                const logoutBtn = document.getElementById('logoutBtn');
                const newDiscussionBtn = document.getElementById('newDiscussionBtn');

                if (loginBtn) {
                    loginBtn.addEventListener('click', auth.login);
                }

                if (logoutBtn) {
                    logoutBtn.addEventListener('click', auth.logout);
                }

                if (currentUser && newDiscussionBtn) {
                    newDiscussionBtn.style.display = 'inline-flex';
                    newDiscussionBtn.addEventListener('click', () => {
                        window.location.href = `new-discussion.html?category=${currentCategoryId}`;
                    });
                }
            } catch (error) {
                console.error('Failed to load user:', error);
                ui.renderUserInfo(null, document.getElementById('userInfo'));

                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', auth.login);
                }
            }
        }

        // è¼‰å…¥åˆ†é¡è¨è«–
        async function loadDiscussions(loadMore = false) {
            try {
                if (!loadMore) {
                    ui.renderLoading(document.getElementById('discussionsList'));
                }

                const result = await client.getDiscussions(20, loadMore ? endCursor : null);

                // ç¯©é¸å‡ºç•¶å‰åˆ†é¡çš„è¨è«–
                const categoryDiscussions = result.nodes.filter(d =>
                    d.category.name === currentCategoryName
                );

                if (loadMore) {
                    discussions = [...discussions, ...categoryDiscussions];
                } else {
                    discussions = categoryDiscussions;
                }

                hasNextPage = result.pageInfo.hasNextPage;
                endCursor = result.pageInfo.endCursor;

                ui.renderDiscussions(discussions, document.getElementById('discussionsList'));

                // é¡¯ç¤º/éš±è—è¼‰å…¥æ›´å¤šæŒ‰éˆ•
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                if (hasNextPage && categoryDiscussions.length > 0) {
                    loadMoreBtn.style.display = 'inline-flex';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            } catch (error) {
                ui.renderError(handleError(error, 'loadDiscussions'), document.getElementById('discussionsList'));
            }
        }

        // è¼‰å…¥æ›´å¤šæŒ‰éˆ•äº‹ä»¶
        document.getElementById('loadMoreBtn').addEventListener('click', () => {
            loadDiscussions(true);
        });

        // åˆå§‹åŒ–
        async function init() {
            // å¾ URL ç²å–åˆ†é¡è³‡è¨Š
            currentCategoryId = getQueryParam('id');
            currentCategoryName = decodeURIComponent(getQueryParam('name') || '');

            if (!currentCategoryId || !currentCategoryName) {
                document.getElementById('categoryTitle').textContent = 'âŒ æ‰¾ä¸åˆ°åˆ†é¡';
                document.getElementById('discussionsList').innerHTML = `
          <div class="error-message">
            <strong>éŒ¯èª¤</strong>
            <p>ç„¡æ•ˆçš„åˆ†é¡åƒæ•¸</p>
          </div>
        `;
                return;
            }

            // æ›´æ–°æ¨™é¡Œ
            const translatedName = translateCategoryName(currentCategoryName);
            document.getElementById('categoryTitle').textContent = translatedName;

            await loadUser();
            await loadDiscussions();
        }

        init();
    </script>
</body>

</html>