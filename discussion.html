<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨è«–è©³æƒ… - GitHub Discussions è«–å£‡</title>
    <link rel="stylesheet" href="src/styles/main.css">
    <style>
        /* è¨è«–è©³æƒ…å°ˆç”¨æ¨£å¼ */
        .discussion-detail {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .discussion-detail-header {
            margin-bottom: var(--spacing-xl);
        }

        .discussion-detail-title {
            font-size: 2rem;
            font-weight: 700;
            margin: var(--spacing-md) 0;
            line-height: 1.3;
        }

        .discussion-detail-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .author-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
        }

        .author-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .discussion-date {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .discussion-detail-body {
            font-size: 1.05rem;
            line-height: 1.7;
            padding: var(--spacing-lg) 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        .discussion-detail-stats {
            display: flex;
            gap: var(--spacing-lg);
            margin-top: var(--spacing-lg);
            color: var(--text-secondary);
        }

        /* ç•™è¨€å€ */
        .comments-section {
            margin-top: var(--spacing-xl);
        }

        .comments-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: var(--spacing-lg);
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .comment {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .comment-meta {
            display: flex;
            flex-direction: column;
        }

        .comment-author {
            font-weight: 600;
            color: var(--text-primary);
        }

        .comment-date {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .comment-body {
            padding-left: 52px;
        }

        .comment-replies {
            margin-left: var(--spacing-xl);
            margin-top: var(--spacing-lg);
            padding-left: var(--spacing-lg);
            border-left: 2px solid var(--border-color);
        }

        /* ç•™è¨€è¡¨å–® */
        .comment-form {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .comment-form textarea {
            width: 100%;
            min-height: 120px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }

        .comment-form textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .comment-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--text-secondary);
            text-decoration: none;
            margin-bottom: var(--spacing-lg);
            transition: color var(--transition-fast);
        }

        .back-link:hover {
            color: var(--accent-primary);
        }

        /* åæ‡‰æŒ‰éˆ• */
        .reaction-buttons {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }

        .reaction-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.875rem;
        }

        .reaction-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .reaction-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .reaction-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="index.html" class="navbar-brand">
                ğŸ’¬ GitHub è«–å£‡
            </a>
            <div class="navbar-actions">
                <div id="userInfo"></div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="main-content">
        <div class="container">
            <a href="index.html" class="back-link">
                â† è¿”å›è¨è«–åˆ—è¡¨
            </a>

            <!-- è¨è«–è©³æƒ… -->
            <div id="discussionDetail">
                <!-- è¨è«–å…§å®¹å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            </div>

            <!-- ç•™è¨€è¡¨å–®ï¼ˆéœ€ç™»å…¥ï¼‰ -->
            <div id="commentFormContainer"></div>
        </div>
    </main>

    <!-- é…ç½® -->
    <script>
        window.GITHUB_CONFIG = {
            owner: 'Clank9563',
            repo: 'Clank.github.io'
        };
    </script>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <script type="module">
        import GitHubClient from './src/api/github-client.js';
        import * as auth from './src/api/auth.js';
        import * as ui from './src/js/ui.js';
        import { getQueryParam, handleError } from './src/js/utils.js';

        const client = new GitHubClient(
            window.GITHUB_CONFIG.owner,
            window.GITHUB_CONFIG.repo
        );

        let currentUser = null;
        let currentDiscussion = null;

        // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
        async function loadUser() {
            try {
                currentUser = await client.getCurrentUser();
                ui.renderUserInfo(currentUser, document.getElementById('userInfo'));

                const loginBtn = document.getElementById('loginBtn');
                const logoutBtn = document.getElementById('logoutBtn');

                if (loginBtn) {
                    loginBtn.addEventListener('click', auth.login);
                }

                if (logoutBtn) {
                    logoutBtn.addEventListener('click', auth.logout);
                }

                // å¦‚æœå·²ç™»å…¥ï¼Œé¡¯ç¤ºç•™è¨€è¡¨å–®
                if (currentUser) {
                    renderCommentForm();
                }
            } catch (error) {
                console.error('Failed to load user:', error);
                ui.renderUserInfo(null, document.getElementById('userInfo'));

                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', auth.login);
                }
            }
        }

        // è¼‰å…¥è¨è«–è©³æƒ…
        async function loadDiscussion() {
            const number = getQueryParam('number');

            if (!number) {
                ui.renderError('æ‰¾ä¸åˆ°è¨è«–ç·¨è™Ÿ', document.getElementById('discussionDetail'));
                return;
            }

            try {
                ui.renderLoading(document.getElementById('discussionDetail'));
                currentDiscussion = await client.getDiscussion(number);
                ui.renderDiscussionDetail(currentDiscussion, document.getElementById('discussionDetail'), currentUser);

                // ç¶å®šæŒ‰è®šæŒ‰éˆ•äº‹ä»¶
                setupReactionButtons();
            } catch (error) {
                ui.renderError(handleError(error, 'loadDiscussion'), document.getElementById('discussionDetail'));
            }
        }

        // è¨­å®šåæ‡‰æŒ‰éˆ•äº‹ä»¶
        function setupReactionButtons() {
            // è¨è«–æŒ‰è®šæŒ‰éˆ•
            const likeBtn = document.getElementById('likeBtn');
            if (likeBtn) {
                likeBtn.addEventListener('click', async () => {
                    if (!currentUser) {
                        alert('è«‹å…ˆç™»å…¥');
                        return;
                    }

                    likeBtn.disabled = true;
                    try {
                        await client.addDiscussionReaction(currentDiscussion.id);
                        const likeCount = document.getElementById('likeCount');
                        likeCount.textContent = parseInt(likeCount.textContent) + 1;
                        likeBtn.classList.add('active');
                    } catch (error) {
                        alert('æŒ‰è®šå¤±æ•—ï¼š' + handleError(error));
                    } finally {
                        likeBtn.disabled = false;
                    }
                });
            }

            // ç½®é ‚æŒ‰éˆ•
            const pinBtn = document.getElementById('pinBtn');
            if (pinBtn && currentUser) {
                pinBtn.addEventListener('click', async () => {
                    pinBtn.disabled = true;

                    // å¾ localStorage ç²å–ç½®é ‚åˆ—è¡¨
                    const pinnedDiscussions = JSON.parse(localStorage.getItem('pinnedDiscussions') || '[]');
                    const discussionId = currentDiscussion.id;
                    const isPinned = pinnedDiscussions.includes(discussionId);

                    try {
                        if (isPinned) {
                            // å–æ¶ˆç½®é ‚ï¼šå¾åˆ—è¡¨ä¸­ç§»é™¤
                            const index = pinnedDiscussions.indexOf(discussionId);
                            pinnedDiscussions.splice(index, 1);
                            localStorage.setItem('pinnedDiscussions', JSON.stringify(pinnedDiscussions));
                            alert('å·²å–æ¶ˆç½®é ‚');
                        } else {
                            // ç½®é ‚ï¼šåŠ å…¥åˆ—è¡¨
                            pinnedDiscussions.push(discussionId);
                            localStorage.setItem('pinnedDiscussions', JSON.stringify(pinnedDiscussions));
                            alert('å·²ç½®é ‚è¨è«–');
                        }
                        // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°ç‹€æ…‹
                        await loadDiscussion();
                    } catch (error) {
                        alert(`${isPinned ? 'å–æ¶ˆç½®é ‚' : 'ç½®é ‚'}å¤±æ•—ï¼š` + handleError(error));
                    } finally {
                        pinBtn.disabled = false;
                    }
                });
            }

            // ç•™è¨€æŒ‰è®šæŒ‰éˆ•
            document.querySelectorAll('.comment-like-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (!currentUser) {
                        alert('è«‹å…ˆç™»å…¥');
                        return;
                    }

                    const commentId = btn.dataset.commentId;
                    btn.disabled = true;

                    try {
                        await client.addCommentReaction(commentId);
                        const countSpan = btn.querySelector('.comment-like-count');
                        countSpan.textContent = parseInt(countSpan.textContent) + 1;
                        btn.classList.add('active');
                    } catch (error) {
                        alert('æŒ‰è®šå¤±æ•—ï¼š' + handleError(error));
                    } finally {
                        btn.disabled = false;
                    }
                });
            });
        }

        // æ¸²æŸ“ç•™è¨€è¡¨å–®
        function renderCommentForm() {
            const container = document.getElementById('commentFormContainer');
            container.innerHTML = `
        <div class="comment-form">
          <h3>ç™¼è¡¨ç•™è¨€</h3>
          <textarea id="commentBody" placeholder="è¼¸å…¥æ‚¨çš„ç•™è¨€ï¼ˆæ”¯æ´ Markdownï¼‰..."></textarea>
          <div class="comment-form-actions">
            <button class="btn btn-primary" id="submitCommentBtn">
              ğŸ’¬ ç™¼è¡¨ç•™è¨€
            </button>
          </div>
        </div>
      `;

            document.getElementById('submitCommentBtn').addEventListener('click', submitComment);
        }

        // æäº¤ç•™è¨€
        async function submitComment() {
            const body = document.getElementById('commentBody').value.trim();

            if (!body) {
                alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹');
                return;
            }

            if (!currentDiscussion) {
                alert('æ‰¾ä¸åˆ°è¨è«–');
                return;
            }

            try {
                const btn = document.getElementById('submitCommentBtn');
                btn.disabled = true;
                btn.textContent = 'ç™¼è¡¨ä¸­...';

                await client.addComment(currentDiscussion.id, body);

                // é‡æ–°è¼‰å…¥è¨è«–ä»¥é¡¯ç¤ºæ–°ç•™è¨€
                await loadDiscussion();

                // æ¸…ç©ºè¡¨å–®
                document.getElementById('commentBody').value = '';

                alert('ç•™è¨€ç™¼è¡¨æˆåŠŸï¼');
            } catch (error) {
                alert('ç•™è¨€ç™¼è¡¨å¤±æ•—ï¼š' + handleError(error, 'submitComment'));
            } finally {
                const btn = document.getElementById('submitCommentBtn');
                btn.disabled = false;
                btn.textContent = 'ğŸ’¬ ç™¼è¡¨ç•™è¨€';
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            await loadUser();
            await loadDiscussion();
        }

        init();
    </script>
</body>

</html>